arguments:
    parameters:
        - displayName: Dataset path
          hint: Path to annotated data (COCO format) in default object storage. In CVAT, this parameter will be pre-populated.
          name: cvat-annotation-path
          value: artifacts/{{workflow.namespace}}/annotations/
          visibility: internal
        - displayName: Validation split size
          hint: Enter validation set size in percentage of full dataset. (0 - 100)
          name: val-split
          type: input.number
          value: 10
          visibility: public
        - displayName: Number of augmentation cycles
          hint: Number of augmentation cycles, zero means no data augmentation
          name: num-augmentation-cycles
          type: input.number
          value: 1
          visibility: public
        - displayName: Preprocessing parameters
          hint: See <a href="https://albumentations.ai/docs/api_reference/augmentations/transforms/" target="_blank">documentation</a> for more information on parameters.
          name: preprocessing-parameters
          type: textarea.textarea
          value: |-
            RandomBrightnessContrast:
                p: 0.2
            GaussianBlur:
                p: 0.3
            GaussNoise:
                p: 0.4
            HorizontalFlip:
                p: 0.5
            VerticalFlip:
                p: 0.3
          visibility: public
        - displayName: Number of classes
          hint: Number of classes. In CVAT, this parameter will be pre-populated.
          name: cvat-num-classes
          value: "10"
          visibility: internal
        - displayName: Hyperparameters
          hint: See <a href="https://docs.onepanel.ai/docs/reference/workflows/training#maskrcnn-hyperparameters" target="_blank">documentation</a> for more information on parameters.
          name: hyperparameters
          type: textarea.textarea
          value: |-
            stage_1_epochs: 1    #  Epochs for network heads
            stage_2_epochs: 1    #  Epochs for finetune layers
            stage_3_epochs: 1    #  Epochs for all layers
            num_steps: 1000     #  Num steps per epoch
          visibility: public
        - displayName: CVAT dump format
          name: dump-format
          value: cvat_coco
          visibility: private
        - displayName: Checkpoint path
          hint: Path to the last fine-tune checkpoint for this model in default object storage. Leave empty if this is the first time you're training this model.
          name: cvat-finetune-checkpoint
          value: ""
          visibility: public
        - displayName: Node pool
          hint: Name of node pool or group to run this workflow task
          name: sys-node-pool
          required: true
          type: select.nodepool
          value: 'gpu'
          visibility: public
entrypoint: main
templates:
    - dag:
        tasks:
            - name: preprocessing
              template: preprocessing
            - arguments:
                artifacts:
                    - from: '{{tasks.preprocessing.outputs.artifacts.processed-data}}'
                      name: data
              dependencies:
                - preprocessing
              name: train-model
              template: tensorflow
      name: main
    - container:
        args:
            - |
              pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
              pip install pycocotools scikit-image==0.16.2 && \
              cd /mnt/src/train/workflows/maskrcnn-training && \
              python -u main.py train --dataset=/mnt/data/datasets/train_set/ \
                --model=workflow_maskrcnn \
                --extras="{{workflow.parameters.hyperparameters}}"  \
                --ref_model_path="{{workflow.parameters.cvat-finetune-checkpoint}}"  \
                --num_classes="{{workflow.parameters.cvat-num-classes}}" \
                --val_dataset=/mnt/data/datasets/eval_set/ \
                --use_validation=True
        command:
            - sh
            - -c
        image: onepanel/dl:v0.20.0
        volumeMounts:
            - mountPath: /mnt/data
              name: processed-data
            - mountPath: /mnt/output
              name: output
        workingDir: /mnt/src
      inputs:
        artifacts:
            - name: data
              path: /mnt/data/datasets/
            - name: models
              optional: true
              path: /mnt/data/models/
              s3:
                key: '{{workflow.parameters.cvat-finetune-checkpoint}}'
            - git:
                repo: https://gitclone.com/github.com/onepanelio/templates.git
                revision: v0.18.0
              name: src
              path: /mnt/src/train
      name: tensorflow
      nodeSelector:
        'beta.kubernetes.io/instance-type': '{{workflow.parameters.sys-node-pool}}'
      outputs:
        artifacts:
            - name: model
              optional: true
              path: /mnt/output
      sidecars:
        - args:
            - tensorboard --logdir /mnt/output/tensorboard
          command:
            - sh
            - -c
          env:
            - name: ONEPANEL_INTERACTIVE_SIDECAR
              value: "true"
          image: onepanel/dl:v0.20.0
          name: tensorboard
          ports:
            - containerPort: 6006
              name: tensorboard
    - container:
        args:
            - |
              pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple && \
              pip install pycocotools && \
              cd /mnt/src/preprocessing/workflows/albumentations-preprocessing && \
              python -u main.py \
                --data_aug_params="{{workflow.parameters.preprocessing-parameters}}" \
                --val_split={{workflow.parameters.val-split}} \
                --aug_steps={{workflow.parameters.num-augmentation-cycles}}
        command:
            - sh
            - -c
        image: onepanel/dl:v0.20.0
        volumeMounts:
            - mountPath: /mnt/data
              name: data
            - mountPath: /mnt/output
              name: processed-data
        workingDir: /mnt/src
      inputs:
        artifacts:
            - name: data
              path: /mnt/data/datasets/
              s3:
                key: '{{workflow.parameters.cvat-annotation-path}}'
            - git:
                repo: https://gitclone.com/github.com/onepanelio/templates.git
                revision: v0.18.0
              name: src
              path: /mnt/src/preprocessing
      name: preprocessing
      nodeSelector:
        'beta.kubernetes.io/instance-type': '{{workflow.parameters.sys-node-pool}}'
      outputs:
        artifacts:
            - name: processed-data
              optional: true
              path: /mnt/output
volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
            - ReadWriteOnce
        resources:
            requests:
                storage: 10Gi
    - metadata:
        name: processed-data
      spec:
        accessModes:
            - ReadWriteOnce
        resources:
            requests:
                storage: 10Gi
    - metadata:
        name: output
      spec:
        accessModes:
            - ReadWriteOnce
        resources:
            requests:
                storage: 10Gi
